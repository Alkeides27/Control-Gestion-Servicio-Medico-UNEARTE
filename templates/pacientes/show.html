{% extends 'base.html' %}

{% block title %}Detalles del Paciente{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h1 class="dashboard-title">Detalles del Paciente</h1>
    <div>
        <a href="{% url 'pacientes:edit' paciente.id %}" class="btn btn-outline-medical me-2">
            <i class="bi bi-pencil"></i> Editar
        </a>
        <a href="{% url 'pacientes:destroy' paciente.id %}" class="btn btn-outline-danger">
            <i class="bi bi-trash"></i> Eliminar
        </a>
    </div>
</div>

<div class="row">
    <div class="col-md-8">
        <div class="card card-medical mb-4">
            <div class="card-header-medical">
                <h5 class="card-title mb-0">
                    <i class="bi bi-person"></i> Información Personal
                </h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-sm-3">
                        <strong>Nombre:</strong>
                    </div>
                    <div class="col-sm-9">
                        {{ paciente.nombre }} {{ paciente.apellido }}
                    </div>
                </div>
                <hr>
                <div class="row">
                    <div class="col-sm-3">
                        <strong>Número de Documento:</strong>
                    </div>
                    <div class="col-sm-9">
                        {{ paciente.numero_documento }}
                    </div>
                </div>
                <hr>
                <div class="row">
                    <div class="col-sm-3">
                        <strong>Fecha de Nacimiento:</strong>
                    </div>
                    <div class="col-sm-9">
                        {{ paciente.fecha_nacimiento|date:"d/m/Y" }}
                    </div>
                </div>
                <hr>
                <div class="row">
                    <div class="col-sm-3">
                        <strong>Edad:</strong>
                    </div>
                    <div class="col-sm-9">
                        {{ paciente.edad }} años
                    </div>
                </div>
                <hr>
                <div class="row">
                    <div class="col-sm-3">
                        <strong>Género:</strong>
                    </div>
                    <div class="col-sm-9">
                        {{ paciente.genero }}
                    </div>
                </div>
                <hr>
                <div class="row">
                    <div class="col-sm-3">
                        <strong>Email:</strong>
                    </div>
                    <div class="col-sm-9">
                        {{ paciente.email|default:"No especificado" }}
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-md-4">
        <div class="card card-medical mb-4">
            <div class="card-header-medical">
                <h5 class="card-title mb-0">
                    <i class="bi bi-telephone"></i> Teléfonos
                </h5>
            </div>
            <div class="card-body">
                {% if telefonos %}
                    <ul class="list-group">
                        {% for telefono in telefonos %}
                            <li class="list-group-item">
                                <strong>{{ telefono.tipo_telefono }}:</strong> {{ telefono.numero }}
                                {% if telefono.es_principal %}
                                    <span class="badge bg-primary">Principal</span>
                                {% endif %}
                            </li>
                        {% endfor %}
                    </ul>
                {% else %}
                    <p class="text-muted">No se han registrado teléfonos.</p>
                {% endif %}
            </div>
        </div>
        
        <div class="card card-medical">
            <div class="card-header-medical">
                <h5 class="card-title mb-0">
                    <i class="bi bi-geo-alt"></i> Direcciones
                </h5>
            </div>
            <div class="card-body">
                {% if direcciones %}
                    <ul class="list-group">
                        {% for direccion in direcciones %}
                            <li class="list-group-item">
                                {{ direccion.direccion }}, {{ direccion.ciudad }}
                                {% if direccion.es_principal %}
                                    <span class="badge bg-primary">Principal</span>
                                {% endif %}
                            </li>
                        {% endfor %}
                    </ul>
                {% else %}
                    <p class="text-muted">No se han registrado direcciones.</p>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<div class="mt-4">
    <h3>Historiales Clínicos del Paciente</h3>
    {% if historiales_del_paciente %}
        <div class="card card-medical">
            <div class="card-body p-0">
                <div class="table-responsive">
                    <table class="table table-hover mb-0">
                        <thead class="table-light">
                            <tr>
                                <th>Fecha</th>
                                <th>Médico</th>
                                <th>Tipo de Historia</th>
                                <th>Motivo de Consulta</th>
                                <th>Acciones</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for historial in historiales_del_paciente %}
                                <tr>
                                    <td>{{ historial.fecha|date:"d/m/Y H:i" }}</td>
                                    <td>{{ historial.medico.get_full_name|default:"No asignado" }}</td>
                                    <td>
                                        {% if historial.historia_general %}
                                            <span class="badge bg-primary">Historia General</span>
                                        {% elif historial.historia_nutricion %}
                                            <span class="badge bg-success">Historia Nutrición</span>
                                        {% else %}
                                            <span class="badge bg-secondary">Consulta Básica</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        {% if historial.historia_general %}
                                            {{ historial.historia_general.motivo_consulta|truncatewords:10|default:"No registrado" }}
                                        {% elif historial.historia_nutricion %}
                                            {{ historial.historia_nutricion.motivo_consulta_nutricion|truncatewords:10|default:"No registrado" }}
                                        {% else %}
                                            Consulta sin detalles
                                        {% endif %}
                                    </td>
                                    <td>
                                        <a href="{% url 'historiales:show' historial.id %}" class="btn btn-info btn-sm" title="Ver historial">
                                            <i class="bi bi-eye-fill"></i>
                                        </a>
                                        
                                        {% if historial.medico == request.user or request.user.perfilusuario.rol == 'admin' %}
                                            <a href="{% url 'historiales:edit' historial.id %}" class="btn btn-primary btn-sm" title="Editar historial">
                                                <i class="bi bi-pencil-fill"></i>
                                            </a>
                                            <a href="{% url 'historiales:destroy' historial.id %}" class="btn btn-danger btn-sm" title="Eliminar historial">
                                                <i class="bi bi-trash-fill"></i>
                                            </a>
                                        {% endif %}
                                    </td>
                                </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    {% else %}
        <div class="alert alert-info" role="alert">
            <i class="bi bi-info-circle"></i> Este paciente aún no tiene historiales médicos registrados.
        </div>
    {% endif %}

    <a href="{% url 'historiales:create' %}?paciente_id={{ paciente.id }}" class="btn btn-success mt-3">
        <i class="bi bi-plus-circle-fill"></i> Crear Nuevo Historial
    </a>
</div>

<div class="mt-4">
    <a href="{% url 'pacientes:index' %}" class="btn btn-outline-medical">
        <i class="bi bi-arrow-left"></i> Volver al listado
    </a>
</div>
{% endblock %}